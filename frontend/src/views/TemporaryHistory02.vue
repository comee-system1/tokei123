<template>
  <v-container fluid id="main02">
    <v-container fluid>
      <v-row dense>
        <v-col sm="9">
          <v-row>
            <v-col col="12" class="d-flex flex-row">
              <div class="pa-2">サービス</div>
              <wj-combo-box
                :textChanged="onTextChanged"
                text="11210000 障碍者支援 ひまわり"
                style="width: 300px"
              ></wj-combo-box>
              <wj-combo-box :items-source="search"></wj-combo-box>
            </v-col>
          </v-row>
          <v-row>
            <v-col col="12" class="d-flex flex-row">
              <div class="pa-2">提供月</div>
              <input
                type="month"
                name="example"
                :value="year + '-' + month"
                v-on:change="calenderChange"
              />
            </v-col>
          </v-row>
        </v-col>
        <v-col sm="3">
          <v-row justify="end">
            <v-btn>登録</v-btn>
          </v-row>
        </v-col>
      </v-row>
    </v-container>

    <v-container fluid>
      <v-row>
        <user-list-print
          @child-select="setUserSelectPoint"
          @child-event="createInfo"
          @child-user="childSelectUser"
        >
        </user-list-print>
        <v-col cols="10">
          <v-container fluid>
            <v-row>
              <v-col cols="2">
                <v-row class="border-bottom">
                  <v-col class="pa-2" cols="3"
                    ><label><b>利用者</b></label></v-col
                  >
                  <v-col class="pa-2" cols="*"
                    ><span id="selectUserText"></span>
                  </v-col>
                </v-row>
              </v-col>
              <v-col cols="1">
                <v-row>
                  <v-col class="pa-2">
                    <v-btn x-small @click="onMoveUser('back')"
                      ><span class="wj-glyph-left"></span></v-btn
                    >&nbsp;
                    <v-btn x-small @click="onMoveUser('next')"
                      ><span class="wj-glyph-right"></span
                    ></v-btn>
                  </v-col>
                </v-row>
              </v-col>
              <v-col cols="3">
                <v-row class="border-bottom">
                  <v-col class="pa-2" cols="4"
                    ><label class="pa-2"><b>受給者証番号</b></label></v-col
                  >
                  <v-col class="pa-2" cols="*"
                    ><span id="selectUserExamNumber"></span>
                  </v-col>
                </v-row>
              </v-col>
              <v-col cols="*">
                <v-row>
                  <v-col class="pa-2" cols="*"
                    ><small
                      >最終編集者: R03.08.08 12:36 (担当者：大正雅夫)</small
                    >
                  </v-col>
                </v-row>
              </v-col>
            </v-row>
          </v-container>
          <v-container class="py-0 px-0 ma-6 mt-6">
            <v-card
              class="pa-5 overflow-auto"
              md="auto"
              max-height="130"
              max-width="1280"
            >
              <v-row no-gutters>
                <v-col md="auto">
                  <v-card class="pa-2 text-center text-caption" elevation="0">
                    <label class="font-weight-black">援護者</label>
                  </v-card>
                </v-col>
                <v-col md="auto">
                  <v-card
                    class="pa-2"
                    elevation="0"
                    v-for="(n, index) in helper.helper"
                    :key="index"
                    :min-width="100"
                  >
                    <span>{{ n.name }}</span>
                    <span class="ml-2">{{ n.term }}</span>
                  </v-card>
                </v-col>
                <v-col md="auto" class="ml-4">
                  <v-card class="pa-2 text-center text-caption" elevation="0">
                    <label class="font-weight-black">助成自治体番号</label>
                  </v-card>
                </v-col>
                <v-col md="auto">
                  <v-card class="pa-2" elevation="0" :min-width="100">
                    {{ helper.helperNum }}
                  </v-card>
                </v-col>
                <v-col md="auto" class="ml-4">
                  <v-card class="pa-2 text-caption" elevation="0">
                    <label class="font-weight-black">障害種別</label>
                  </v-card>
                  <v-card class="pa-2 text-caption" elevation="0">
                    <label class="font-weight-black">障害支区</label>
                  </v-card>
                </v-col>
                <v-col md="auto">
                  <v-card class="pa-2" elevation="0" :min-width="100">
                    {{ helper.personType }}
                  </v-card>
                  <v-card class="pa-2" elevation="0" :min-width="100">
                    {{ helper.personHelp }}
                  </v-card>
                </v-col>
                <v-col md="auto" class="ml-4">
                  <v-card class="pa-2 text-caption" elevation="0">
                    <label class="font-weight-black">負担上限額</label>
                  </v-card>
                  <v-card class="pa-2 text-caption" elevation="0">
                    <label class="font-weight-black">特別給付費</label>
                  </v-card>
                </v-col>
                <v-col md="auto">
                  <v-card class="pa-2" elevation="0" :min-width="100">
                    {{ helper.chargeMaxMoney }}
                  </v-card>
                  <v-card class="pa-2" elevation="0" :min-width="100">
                    {{ helper.specialMoney }}
                  </v-card>
                </v-col>

                <v-col md="auto" class="ml-4">
                  <v-card class="pa-2 text-center text-caption" elevation="0">
                    <label class="font-weight-black">上限管理事</label>
                  </v-card>
                </v-col>
                <v-col md="auto">
                  <v-card
                    class="pa-2"
                    elevation="0"
                    v-for="(n, index) in helper.limitAdmin"
                    :key="index"
                    :min-width="100"
                  >
                    <span>{{ n.name }}</span>
                    <span class="ml-2">{{ n.term }}</span>
                  </v-card>
                </v-col>
              </v-row>
            </v-card>
          </v-container>

          <v-container mt-0 pt-0 fluid>
            <div class="float-left">
              <a class="ml-2 addButton" @click="dialogTerm()">期間追加</a>
              <a class="ml-2 addButton" @click="dialogAdd()">加算追加</a>
            </div>
            <div class="d-flex justify-end">
              <div class="mt-1">
                <v-img src="../assets/tyusyaku_01.png"></v-img>
              </div>
              <div class="ml-2"><small>:編集可能</small></div>

              <div class="ml-5 mt-1">
                <v-img src="../assets/tyusyaku_02.png"></v-img>
              </div>
              <div class="ml-2"><small>:入退院</small></div>

              <div class="ml-5 mt-1">
                <v-img src="../assets/tyusyaku_03.png"></v-img>
              </div>
              <div class="ml-2"><small>:外泊</small></div>

              <div class="ml-5 editMark"></div>
              <div class="ml-2"><small>:手修正済み</small></div>
            </div>
          </v-container>

          <wj-flex-grid
            id="theGridTallRows"
            :itemsSource="infoData"
            :initialized="onInitializedInfo"
            :headersVisibility="'Column'"
            :isReadOnly="true"
            :allowDragging="false"
            :allowResizing="false"
            :deferResizing="false"
            :allowSorting="false"
          >
            <wj-flex-grid-column
              header=" "
              binding="space"
              :width="30"
              :wordWrap="true"
            ></wj-flex-grid-column>
            <wj-flex-grid-column
              header="項目"
              binding="item"
              :width="300"
              :wordWrap="true"
              :allowMerging="true"
            ></wj-flex-grid-column>
            <wj-flex-grid-column
              v-for="d in daycount"
              :key="d"
              :width="35"
              :header="year + '/' + month + '/' + d"
              :binding="'day' + d"
              :wordWrap="true"
              :allowResizing="false"
              :isReadOnly="true"
            ></wj-flex-grid-column>
            <wj-flex-grid-column
              header="合計"
              binding="totals"
              width="*"
              :wordWrap="true"
            ></wj-flex-grid-column>
            <wj-flex-grid-column
              header="金額"
              binding="money"
              width="*"
              :wordWrap="true"
            ></wj-flex-grid-column>

            <div v-for="n in borders" :key="n.key">
              <div
                class="borderPlace"
                v-bind:style="{
                  width: n.width + 'px',
                  left: n.left + 'px',
                  top: n.top + 'px',
                  backgroundColor: n.color,
                }"
              >
                <div
                  class="borderPlace--left"
                  v-bind:style="{
                    'border-color':
                      'transparent ' + n.color + ' transparent  transparent',
                  }"
                ></div>
                <div
                  class="borderPlace--right"
                  v-bind:style="{
                    'border-color':
                      'transparent  transparent  transparent ' + n.color,
                  }"
                ></div>
              </div>
              <a
                class="borderBox"
                v-bind:style="{ left: n.left + 'px', top: n.top + 'px' }"
                @click="dialogTerm()"
              >
                {{ n.st }}～{{ n.ed }}[{{ n.diff }}]
              </a>
            </div>
          </wj-flex-grid>
        </v-col>
      </v-row>
    </v-container>

    <v-dialog v-model="dialog" width="500">
      <v-card>
        <v-card-title class="text-h5 grey lighten-2">
          変動情報登録
        </v-card-title>
        <v-card class="d-flex justify-center" flat>
          <v-card class="pa-2" elevation="0">
            <v-btn-toggle mandatory>
              <v-btn class="primary">入退院</v-btn>
              <v-btn class="primary">外泊</v-btn>
            </v-btn-toggle>
          </v-card>
        </v-card>

        <v-container class="lighten-5">
          <v-row no-gutters style="flex-wrap: nowrap">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="80"
                color="blue-grey lighten-5"
                >入院日
              </v-card>
            </v-col>
            <v-col cols="8" class="flex-grow-0 flex-shrink-0 ml-2">
              <v-card class="pa-0" elevation="0">
                <datepicker
                  :language="ja"
                  class="input_picker"
                  :format="DatePickerFormat"
                ></datepicker>
                <v-card class="d-flex mb-6" color="lighten-2" flat tile>
                  <v-card class="pa-0" elevation="0">
                    <v-radio-group row
                      >施設の利用
                      <v-radio
                        label="あり"
                        value="radio-1"
                        class="ml-2"
                      ></v-radio>
                      <v-radio label="なし" value="radio-2"></v-radio>
                    </v-radio-group>
                  </v-card>
                </v-card>
              </v-card>
            </v-col>
          </v-row>
          <v-row no-gutters style="flex-wrap: nowrap" class="mt-n5 mx-auto">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="30"
                color="blue-grey lighten-5"
                >食事
              </v-card>
            </v-col>
            <v-col cols="8" class="mt-n5 mx-auto">
              <v-card class="d-flex" elevation="0">
                <v-card class="pa-2" elevation="0">
                  <v-checkbox
                    label="朝食"
                    value="朝食"
                    hide-details
                  ></v-checkbox>
                </v-card>
                <v-card class="pa-2" elevation="0">
                  <v-checkbox
                    label="昼食"
                    value="昼食"
                    hide-details
                  ></v-checkbox>
                </v-card>
                <v-card class="pa-2" elevation="0">
                  <v-checkbox
                    label="夕食"
                    value="夕食"
                    hide-details
                  ></v-checkbox>
                </v-card>
              </v-card>
            </v-col>
          </v-row>
          <v-row no-gutters style="flex-wrap: nowrap" class="mt-3">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="30"
                color="blue-grey lighten-5"
                >病院名
              </v-card>
            </v-col>
            <v-col cols="8">
              <v-card class="pa-0" elevation="0">
                <v-text-field
                  label="病院名を入力"
                  class="ml-2 mt-n2 mx-auto"
                ></v-text-field>
              </v-card>
            </v-col>
          </v-row>
        </v-container>
        <v-container class="lighten-5">
          <v-row no-gutters style="flex-wrap: nowrap">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="80"
                color="blue-grey lighten-5"
                >入院日
              </v-card>
            </v-col>
            <v-col cols="8" class="flex-grow-0 flex-shrink-0 ml-2">
              <v-card class="pa-0" elevation="0">
                <datepicker
                  :language="ja"
                  class="input_picker"
                  :format="DatePickerFormat"
                ></datepicker>
                <v-card class="d-flex mb-6" color="lighten-2" flat tile>
                  <v-card class="pa-0" elevation="0">
                    <v-radio-group row
                      >施設の利用
                      <v-radio
                        label="あり"
                        value="radio-1"
                        class="ml-2"
                      ></v-radio>
                      <v-radio label="なし" value="radio-2"></v-radio>
                    </v-radio-group>
                  </v-card>
                </v-card>
              </v-card>
            </v-col>
          </v-row>
          <v-row no-gutters style="flex-wrap: nowrap" class="mt-n5 mx-auto">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="30"
                color="blue-grey lighten-5"
                >食事
              </v-card>
            </v-col>
            <v-col cols="8" class="mt-n5 mx-auto">
              <v-card class="d-flex" elevation="0">
                <v-card class="pa-2" elevation="0">
                  <v-checkbox
                    label="朝食"
                    value="朝食"
                    hide-details
                  ></v-checkbox>
                </v-card>
                <v-card class="pa-2" elevation="0">
                  <v-checkbox
                    label="昼食"
                    value="昼食"
                    hide-details
                  ></v-checkbox>
                </v-card>
                <v-card class="pa-2" elevation="0">
                  <v-checkbox
                    label="夕食"
                    value="夕食"
                    hide-details
                  ></v-checkbox>
                </v-card>
              </v-card>
            </v-col>
          </v-row>

          <v-card class="d-flex mt-3" elevation="0">
            <v-card elevation="0">
              <v-btn color="primary" text @click="dialog = false"> 削除 </v-btn>
            </v-card>
            <v-card elevation="0">
              <v-btn color="primary" text @click="dialog = false">
                クリア
              </v-btn>
            </v-card>
            <v-card elevation="0" class="ml-auto">
              <v-btn color="primary" text @click="dialog = false"> 登録 </v-btn>
            </v-card>
          </v-card>
        </v-container>
      </v-card>
    </v-dialog>

    <v-dialog v-model="dialog_add" width="500">
      <v-card>
        <v-card-title class="text-h5 grey lighten-2">
          個別加算追加登録
        </v-card-title>
        <v-card class="d-flex justify-center" flat>
          <v-card class="pa-2" elevation="0">
            <wj-combo-box :items-source="addSelect"></wj-combo-box>
          </v-card>
        </v-card>
        <v-container class="lighten-5">
          <v-row no-gutters style="flex-wrap: nowrap">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card class="pa-2" outlined tile color="blue-grey lighten-5"
                >開始日
              </v-card>
            </v-col>
            <v-col cols="8" class="flex-grow-0 flex-shrink-0 ml-2">
              <v-card elevation="0">
                <datepicker
                  :language="ja"
                  :format="DatePickerFormat"
                  class="input_picker mt-2"
                ></datepicker>
              </v-card>
            </v-col>
          </v-row>
          <v-row no-gutters style="flex-wrap: nowrap">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0 mt-2">
              <v-card class="pa-2" outlined tile color="blue-grey lighten-5"
                >終了日
              </v-card>
            </v-col>
            <v-col cols="8" class="flex-grow-0 flex-shrink-0 ml-2 mt-2">
              <v-card elevation="0">
                <datepicker
                  :language="ja"
                  :format="DatePickerFormat"
                  class="input_picker mt-2"
                ></datepicker>
              </v-card>
            </v-col>
          </v-row>
          <v-row no-gutters style="flex-wrap: nowrap" class="mt-5 mx-auto">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="30"
                color="blue-grey lighten-5"
                >単位数
              </v-card>
            </v-col>
            <v-col cols="8" class="mt-2 ml-2 mx-auto"> 30単位/日 </v-col>
          </v-row>
          <v-row no-gutters style="flex-wrap: nowrap" class="mt-3">
            <v-col cols="4" class="flex-grow-0 flex-shrink-0">
              <v-card
                class="pa-2"
                outlined
                tile
                min-height="30"
                color="blue-grey lighten-5"
                >留意事項
              </v-card>
            </v-col>
            <v-col cols="8">
              <ol>
                <li>入所日(算定日)から30日を限度</li>
                <li>同一敷地外の病院に30日以上入院した場合は、再算定可能</li>
                <li>過去3ヶ月間に入所理由がないこと</li>
              </ol>
            </v-col>
          </v-row>

          <v-card class="d-flex mt-3" elevation="0">
            <v-card elevation="0">
              <v-btn color="primary" text @click="dialog_add = false">
                削除
              </v-btn>
            </v-card>
            <v-card elevation="0">
              <v-btn color="primary" text @click="dialog_add = false">
                クリア
              </v-btn>
            </v-card>
            <v-card elevation="0" class="ml-auto">
              <v-btn color="primary" text @click="dialog_add = false">
                登録
              </v-btn>
            </v-card>
          </v-card>
        </v-container>
      </v-card>
    </v-dialog>
  </v-container>
</template>

<script>
import * as wjCore from '@grapecity/wijmo';

import '@grapecity/wijmo.vue2.input';
import '@grapecity/wijmo.vue2.grid';

import moment from 'moment';
import '@grapecity/wijmo.cultures/wijmo.culture.ja';
import customMerge from '@/utiles/customMerge';
import Datepicker from 'vuejs-datepicker';
import { ja } from 'vuejs-datepicker/dist/locale';

import UserListPrint from '../components/UserListPrint.vue';
import isDate from '@/utiles/isDate';
import dateFormatString from '@/utiles/dateFormatString';

//1日分の幅
let oneday = 35;
//グラフはじめのスタート位置
let startPos = 330;
//ユーザーデータ
let userDataSelect = [];

//どこかに共通配列として定義する
const define_first = [];
const define_second = [];
const define_third = [];
define_first[1] = '変動情報';
define_first[2] = '個別加算';
define_second[1] = {
  name: '利用日',
};
define_second[2] = {
  name: '入退院・外泊',
  sub: '期間追加',
};
define_second[3] = {
  name: '食事',
  sub: '朝食',
};
define_second[4] = {
  name: '食事',
  sub: '昼食',
};
define_second[5] = {
  name: '食事',
  sub: '夕食',
};
define_second[6] = {
  name: '光熱水費',
};
define_third[1] = {
  name: '入院外泊時加算Ⅰ',
  editicon: 1,
};
define_third[2] = {
  name: '入院外泊時加算Ⅱ',
  editicon: 1,
};
define_third[3] = {
  name: '栄養マネジメント加算',
  editicon: 1,
};
define_third[4] = {
  name: '療養食加算',
  editicon: 1,
};
define_third[5] = {
  name: '加算追加',
};

let define_week = ['日', '月', '火', '水', '木', '金', '土'];

let year = moment().year();
let month = moment().format('MM');
let userInfo = [];

export default {
  data() {
    return {
      year: year,
      month: month,
      daycount: 0,
      search: ['32:施設入所支援'],
      addSelect: ['入所時特別支援加算'],
      week: define_week,
      isDroppedDown: false,
      borders: this.getBorder(),
      ja: ja,
      infoData: this.createInfoData(),
      selectUserCode: '',
      userRow: 0, //ユーザを選択した配列のrow
      dialog: false,
      dialog_add: false,
      helper: this.getHelperData(),
      DatePickerFormat: 'yyyy年MM月dd日',
    };
  },
  components: {
    Datepicker,
    UserListPrint,
  },
  created() {
    moment.locale('ja');
    this.daycount = moment().daysInMonth();
  },

  methods: {
    childSelectUser(data) {
      userDataSelect = data;
    },
    getHelperData() {
      let helpers = [];
      helpers = {
        helper: [
          {
            name: '東経市',
            term: '7/1～7/9',
          },
          {
            name: '西経市',
            term: '7/10～7/20',
          },
        ],
        limitAdmin: [
          {
            name: 'ひまわり園',
            term: '7/1～7/9',
          },
          {
            name: 'はまなす園',
            term: '7/10～7/30',
          },
        ],
        helperNum: '123456',
        personType: '知的',
        personHelp: '区分4',
        chargeMaxMoney: '9,300円',
        specialMoney: '500円',
      };

      return helpers;
    },
    createInfoData() {
      if (userInfo.length > 0) userInfo = [];
      userInfo.push({
        uniqkey: 1,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[1],
        item: define_second[1].name,
        day3: '1',
        day4: '1',
        day5: '1',
        day22: '1',
        day23: '1',
        day24: '1',
        day25: '1',
        totals: '12',
        money: '2,700円',
      });

      userInfo.push({
        uniqkey: 2,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[1],
        item: define_second[2].name,
      });
      userInfo.push({
        uniqkey: 3,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[1],
        item: define_second[3].name + '_' + define_second[3].sub,
        day3: '2',
        day4: '2',
        day5: '2',
        day22: '3',
        day23: '2',
        day24: '2',
        day25: '2',
      });
      userInfo.push({
        uniqkey: 4,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[1],
        item: define_second[4].name + '_' + define_second[4].sub,
        day3: '2',
        day4: '2',
        day5: '2',
        day22: '3',
        day23: '2',
        day24: '2',
        day25: '2',
      });
      userInfo.push({
        uniqkey: 5,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[1],
        item: define_second[5].name + '_' + define_second[5].sub,
      });
      userInfo.push({
        uniqkey: 6,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[1],
        item: define_second[6].name,
      });
      userInfo.push({
        uniqkey: 7,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[2],
        item: define_third[1].name,
        editicon: define_third[1].editicon,
        day6: '2',
        day7: '2',
        day8: '2',
        day9: '2',
        day10: '2',
        day11: '2',
      });
      userInfo.push({
        uniqkey: 8,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[2],
        item: define_third[2].name,
        editicon: define_third[4].editicon,
        day12: '2',
        day13: '2',
        day14: '2',
        day15: '2',
        day16: '2',
        day17: '2',
      });
      userInfo.push({
        uniqkey: 9,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[2],
        item: define_third[3].name,
        editicon: define_third[4].editicon,
      });
      userInfo.push({
        uniqkey: 10,
        year: 2022,
        month: '04',
        usercode: 1000,
        space: define_first[2],
        item: define_third[4].name,
        editicon: define_third[4].editicon,
      });

      userInfo.push({
        uniqkey: 20,
        year: 2022,
        month: '05',
        usercode: 1000,
        space: define_first[1],
        item: define_second[1].name,
        day6: '1',
        day8: '1',
        day9: '1',
        day24: '1',
        day26: '1',
        day29: '1',
        day30: '1',
      });

      userInfo.push({
        year: 2022,
        month: '04',
        usercode: 1001,
        space: define_first[1],
        item: define_second[1].name,
        day6: '1',
        day8: '1',
        day9: '1',
        day24: '1',
        day26: '1',
        day29: '1',
        day30: '1',
      });

      return this.createInfo();
    },
    calenderChange: function (e) {
      let split = e.target.value.split('-');
      this.year = split[0];
      this.month = split[1];
      let m = moment(this.year + '-' + this.month + '-01');
      this.daycount = m.daysInMonth();

      this.createInfo();
      this.getBorder();
    },
    getBorder: function () {
      if (this.year) year = this.year;
      if (this.month) month = this.month;
      let borderdata = [];

      borderdata.push({
        key: 1,
        year: 2022,
        month: 4,
        start_day: '2022-04-05',
        end_day: '2022-04-22',
        top: 90,
        color: 'red',
      });

      borderdata.push({
        key: 2,
        year: 2022,
        month: 4,
        start_day: '2022-04-28',
        end_day: '2022-04-30',
        top: 90,
        color: 'green',
      });

      let border = [];
      borderdata.forEach(function (value) {
        if (year == value.year && month == value.month) {
          border.push({
            key: value.key,
            year: value.year,
            month: value.month,
            start_day: value.start_day,
            end_day: value.end_day,
            top: value.top,
            color: value.color,
          });
        }
      });

      let converts = [];
      border.forEach(function (conv) {
        //日付の差分
        let m1 = moment(conv.end_day);
        let m2 = moment(conv.start_day);
        converts.push({
          id: conv.id,
          width: oneday * m1.diff(m2, 'days') + oneday,
          left: startPos + oneday * (m2.date() - 1),
          top: conv.top,
          color: conv.color,
          st: m2.format('M/D'),
          ed: m1.format('M/D'),
          diff: m1.diff(m2, 'days'),
        });
      });

      this.borders = converts;

      return converts;
    },
    createInfo: function (ucode = '') {
      //表示用のデータ
      if (this.year) year = this.year;
      if (this.month) month = this.month;
      let returns = [];
      this.infoData = returns;
      //初回ユーザーコード
      let usercode = '';
      if (ucode) {
        usercode = ucode;
      } else {
        usercode = userInfo[0].usercode;
      }
      userInfo.forEach(function (element) {
        if (
          element.year == year &&
          element.month == month &&
          element.usercode == usercode
        ) {
          returns.push({
            year: element.year,
            month: element.month,
            usercode: element.usercode,
            space: element.space,
            item: element.item,
            money: element.money,
            totals: element.totals,
            day1: element.day1,
            day2: element.day2,
            day3: element.day3,
            day4: element.day4,
            day5: element.day5,
            day6: element.day6,
            day7: element.day7,
            day8: element.day8,
            day9: element.day9,
            day10: element.day10,
            day11: element.day11,
            day12: element.day12,
            day13: element.day13,
            day14: element.day14,
            day15: element.day15,
            day16: element.day16,
            day17: element.day17,
            day18: element.day18,
            day19: element.day19,
            day20: element.day20,
            day21: element.day21,
            day22: element.day22,
            day23: element.day23,
            day24: element.day24,
            day25: element.day25,
            day26: element.day26,
            day27: element.day27,
            day28: element.day28,
            day29: element.day29,
            day30: element.day30,
            day31: element.day31,
          });
        }
      });

      this.infoData = returns;
      return this.infoData;
    },

    dialogAdd: function () {
      this.dialog_add = true;
    },
    dialogTerm: function () {
      this.dialog = true;
    },
    onInitializedInfo: function (flexGrid) {
      flexGrid.mergeManager = new customMerge();
      flexGrid.rowHeaders.columns[0].width = 30;
      flexGrid.formatItem.addHandler(cellEdit);
      let _self = this;
      flexGrid.hostElement.addEventListener('click', function (e) {
        var ht = flexGrid.hitTest(e);
        console.log(ht.target.innerText);
        console.log(e.target.innerHTML);

        if (ht.target.innerText == define_second[2].sub) {
          _self.dialog = true;
        } else if (ht.target.innerText == define_third[5].name) {
          _self.dialog_add = true;
        } else if (checkDefineThird(ht.target.innerText, define_third)) {
          _self.dialog_add = true;
        } else if (ht.target.innerText == 'editicon') {
          //個別加算編集アイコン
          _self.dialog = true;
        } else if (e.target.innerHTML == '〇') {
          //赤丸
          e.target.innerText = '×';
        } else if (e.target.innerHTML == '×') {
          e.target.innerHTML = '';
        } else if (
          e.target.innerHTML == '' ||
          e.target.innerHTML == '<div class="red-sign"></div>'
        ) {
          e.target.innerHTML = '<div class="red-sign">〇</div>';
        }
      });
    },

    onTextChanged: function (s) {
      console.log(s.text);
    },
    onMoveUser: function (type) {
      let row;
      if (type == 'next') row = this.userRow + 1;
      if (type == 'back') row = this.userRow - 1;
      if (row <= 0) row = 0;
      if (userDataSelect.length <= row) row = userDataSelect.length;
      this.userRow = row;
      this.setUserSelectPoint(row);
      this.selectUserCode = userDataSelect[row].riyocode;
      this.createInfo(userDataSelect[row].riyocode);
    },
    setUserSelectPoint: function (row) {
      document.querySelector('#selectUserText').innerText =
        userDataSelect[row].riyocode + ' ' + userDataSelect[row].names;
      document.querySelector('#selectUserExamNumber').innerText =
        userDataSelect[row].jyukyuno;
    },
  },
};

function checkDefineThird(s, array) {
  for (let i = 1; i < array.length; i++) {
    if (array[i].name == s) {
      return true;
    }
  }
}

function cellEdit(s, e) {
  if (e.cell.children.length == 0) {
    let align = 'left';
    let str = '';
    if (isDate.isDate(e.cell.innerText)) {
      str = dateFormatString.dateFormatString(e.cell.innerText, define_week);
    } else if (e.cell.innerText == '1') {
      str = "<div class='maru'>maru</div>";
    } else if (e.cell.innerText == '2') {
      str = "<div class='red-sign'>〇</div>";
    } else if (e.cell.innerText == '3') {
      str = "<div class='red-sign'>×</div>";
    } else if (e.cell.innerText == define_second[2].name) {
      str = "<div class='text-left-float'>" + define_second[2].name + '</div>';
    } else if (
      e.cell.innerText ==
      define_second[3].name + '_' + define_second[3].sub
    ) {
      str =
        "<div class='text-left-float'>" +
        define_second[3].name +
        "</div><div class='text-right-float border-right'><p>" +
        define_second[3].sub +
        '</p></div>';
    } else if (
      e.cell.innerText ==
      define_second[4].name + '_' + define_second[4].sub
    ) {
      str =
        "<div class='text-left-float'></div><div class='text-right-float border-right'><p>" +
        define_second[4].sub +
        '</p></div>';
    } else if (
      e.cell.innerText ==
      define_second[5].name + '_' + define_second[5].sub
    ) {
      str =
        "<div class='text-left-float'></div><div class='text-right-float border-right'><p>" +
        define_second[5].sub +
        '</p></div>';
    } else if (e.cell.innerText == '項目') {
      str = "<div class='text-center'>項目</div>";
    } else {
      str = e.cell.innerHTML;
    }
    for (let i = 1; i < define_third.length; i++) {
      if (e.cell.innerText == define_third[i].name) {
        str = '<a>' + define_third[i].name + '</a>';
        break;
      }
    }

    e.cell.innerHTML = '<div>' + str + '</div>';
    wjCore.setCss(e.cell, {
      display: 'table',
      tableLayout: 'fixed',
    });
    wjCore.setCss(e.cell.children[0], {
      display: 'table-cell',
      textAlign: align,
      verticalAlign: 'middle',
    });
  }
}
</script>

<style lang="scss" scope>
//共通cssに移動全体のサイズ
html {
  overflow-x: scroll;
}

div#main02 {
  font-size: 14px;
  font-family: 'メイリオ';

  span#selectUserExamNumber,
  span#selectUserText {
    min-width: 150px;
    display: block;
  }

  div.border-bottom {
    border-bottom: 1px solid #ccc;
    label {
      font-size: 0.85em;
    }
  }

  .maru {
    width: 21px;
    height: 20px;
    background-image: url('../assets/tyusyaku_07.png');
    display: block;
    background-repeat: no-repeat;
    background-size: 90%;
    text-indent: -9999px;
    z-index: -1;
  }

  .red-sign {
    font-size: 1.5em;
    color: red;
    text-align: center;
  }

  div.editMark {
    width: 50px;
    height: 20px;
    background-color: violet;
  }

  a.editicon {
    width: 15px;
    height: 15px;
    display: inline-block;
    background-image: url('../assets/tyusyaku_04.png');
    background-repeat: no-repeat;
    text-indent: -9999px;
  }

  .addButton {
    width: 120px;
    background-color: #fff0f5;
    display: block;
    float: left;
    color: #000 !important;
    text-align: left;
    border-radius: 30px;
    padding: 3px 0px 3px 10px;
    cursor: pointer;
    background-image: url('../assets/plus_15px.png');
    background-position: 95% 50%;
  }

  .wj-cells .wj-cell.wj-state-selected {
    background-color: #f5f5f5 !important;
    color: #000 !important;
  }

  #theGridTallRows {
    position: relative;
  }

  #theGridTallRows.wj-flexgrid .wj-cell {
    height: 40px;
  }

  .wj-rowheaders {
    .wj-row {
      & > div.wj-cell.wj-header {
        & > div {
          transform: translate(-50%, -50%);
          writing-mode: vertical-rl;
        }
      }
    }
  }

  //チャート用
  .borderPlace {
    height: 2px;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    &--left {
      content: '';
      width: 0px;
      height: 0px;
      border: 5px solid;
      display: block;
      position: absolute;
      top: -4px;
      left: -7px;
    }
    &--right {
      content: '';
      border: 1px solid red;
      width: 0px;
      height: 0px;
      border: 5px solid;
      border-color: transparent transparent transparent aqua;
      display: block;
      position: absolute;
      top: -4px;
      right: -7px;
      left: auto;
    }
  }
  .borderBox {
    padding: 2px 30px;
    border: 1px solid #333;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: #fff;
    margin-top: 10px;
    background-image: url('../assets/tyusyaku_04.png');
    background-position: 95% 40%;
  }

  div.text-left-float {
    float: left;
  }
  div.text-right-float {
    float: right;
  }
  div.border-right {
    border-left: 1px solid #ccc;
    width: 150px;
    position: absolute;
    top: 0;
    right: 0;
    padding-left: 20px;
    height: 100%;
  }
  div.border-right p {
    margin: 0;
    position: absolute;
    top: 50%;
    transform: translate(0, -50%);
  }
}
</style>
